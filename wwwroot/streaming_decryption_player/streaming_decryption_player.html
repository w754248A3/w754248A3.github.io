<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>流式解密播放器</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 0 10px;
        }

        .box {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        h2 {
            margin-top: 0;
        }

        video {
            width: 100%;
            background: #000;
            margin-top: 10px;
        }

        button {
            padding: 8px 16px;
            cursor: pointer;
        }

        .log {
            background: #f0f0f0;
            padding: 10px;
            font-size: 12px;
            height: 100px;
            overflow-y: scroll;
        }
    </style>
</head>

<body>

    <h1>Web 视频流式解密 (Android 兼容)</h1>
    <div class="log" id="logArea">日志区域...</div>

   
    <div class="box" style="background-color: #e0f9e0;">
        <h2>▶️ 播放加密文件</h2>
        <p>选择按位取反的混淆文件，浏览器将边解密边播放。</p>
        <input type="file" id="playInput">
        <video id="videoPlayer" controls playsinline></video>
    </div>

    <script>
        const logArea = document.getElementById('logArea');
        function log(msg) {
            logArea.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        const channel = new BroadcastChannel('app-channel_7EAp3pAs');

        channel.onmessage = (event) => {
            const msg = event.data;
            if (msg.type === 'READY_TO_PLAY') {
                log(`收到 READY_TO_PLAY 消息，开始播放视频`);
                playVideo(msg.virtualUrl);
            }
            else if(msg.type === 'LOG_MESSAGE') {
                log(`收到 ERROR 消息，错误信息: ${msg}`);
            }
        };


        window.error = (message, source, lineno, colno, error)=> {
            log(`捕获到全局错误: ${message} at ${source}:${lineno}:${colno}`);
            
        };
        const getIncrementingID = (() => {
            const array = new Uint32Array(10);
            window.crypto.getRandomValues(array);

            let id = array[0];

            return function () {
                return id++;
            }

        })();

        const getVedioFileData = (file) => {

            const virtualUrl = `/virtual-video.mp4?t=${Date.now()}&id=${getIncrementingID()}`;

            return {
                type: "VIDEO_FILE_DATA",

                file: file,
                virtualUrl: virtualUrl
            };

        };

        // --- 2. 播放逻辑 ---
        const playInput = document.getElementById('playInput');
        const videoPlayer = document.getElementById('videoPlayer');

        playInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            log(`已选择播放文件: ${file.name}`);

           
            channel.postMessage( getVedioFileData(file));


        });

        function playVideo(virtualUrl) {


            videoPlayer.src = virtualUrl;
            videoPlayer.play().catch(e => log('自动播放被阻止，请点击播放按钮'));
            videoPlayer.onerror = (e) => {
                log(`播放错误: ${e}`);
            };
        }

      
    </script>
</body>

</html>