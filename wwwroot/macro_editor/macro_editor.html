<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®é…ç½®ç¼–è¾‘å™¨ (Macro Config Editor)</title>
    <style>
        :root {
            --bg-color: #f4f4f9;
            --card-bg: #ffffff;
            --primary: #007bff;
            --danger: #dc3545;
            --success: #28a745;
            --border: #ddd;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: #333;
            padding-bottom: 80px; /* ä¸ºå›åˆ°é¡¶éƒ¨æŒ‰é’®ç•™å‡ºç©ºé—´ */
        }

        /* é¡¶éƒ¨å·¥å…·æ  */
        .toolbar {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-success { background-color: var(--success); color: white; }
        .btn-success:hover { background-color: #1e7e34; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-danger:hover { background-color: #bd2130; }
        .btn-sm { padding: 4px 8px; font-size: 0.85em; }

        /* ä¸»å¸ƒå±€ */
        .container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-start;
        }

        .column {
            flex: 1;
            min-width: 450px; /* ç¨å¾®åŠ å®½æœ€å°å®½åº¦ */
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
        }

        h2 { border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-top: 0; }
        h3, h4 { margin: 10px 0; }

        /* è§„åˆ™å¡ç‰‡ */
        .rule-card {
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 15px;
            background-color: #fff;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .rule-header {
            background-color: #e9ecef;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }

        /* ä¿®æ”¹ï¼šå°† grid æ”¹ä¸º flex columnï¼Œç¡®ä¿å®½åº¦è¶³å¤Ÿ */
        .rule-body {
            padding: 15px;
            display: flex;
            flex-direction: column; 
            gap: 15px;
        }

        .sequence-box {
            background: #f8f9fa;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 4px;
        }

        /* åŠ¨ä½œé¡¹æ ·å¼ */
        .action-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            padding: 5px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
            flex-wrap: nowrap; /* å°½é‡ä¸æ¢è¡Œ */
            overflow-x: auto; /* æç«¯æƒ…å†µä¸‹å…è®¸æ»šåŠ¨ï¼Œä½†ä¸åº”è¯¥å‘ç”Ÿ */
        }

        /* ä¼˜åŒ–è¾“å…¥æ¡†å®½åº¦ */
        .action-item select {
            /* è®©é€‰æ‹©æ¡†ç¨å¾®ç´§å‡‘ä¸€ç‚¹ */
            padding: 4px;
        }
        
        /* é”®åé€‰æ‹©æ¡†ï¼Œå æ®å‰©ä½™ç©ºé—´ */
        .code-select {
            flex-grow: 1;
            min-width: 80px; 
            max-width: 180px;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        input[type="number"] { width: 55px; }

        /* ç¡®ä¿åˆ é™¤æŒ‰é’®ä¸è¢«æŒ¤å‹ */
        .btn-delete {
            flex-shrink: 0;
            margin-left: auto; /* æ¨åˆ°æœ€å³è¾¹ */
        }

        /* å›åˆ°é¡¶éƒ¨æŒ‰é’® */
        #scroll-top-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: none; /* é»˜è®¤éšè— */
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 1000;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, background-color 0.2s;
        }
        
        #scroll-top-btn:hover {
            background-color: #0056b3;
            transform: translateY(-3px);
        }
    </style>
</head>
<body>

    <div class="toolbar">
        <h1>å®é…ç½®ç¼–è¾‘å™¨</h1>
        <div style="margin-left: auto; display: flex; gap: 10px;">
            <button class="btn-primary" onclick="openFile()">ğŸ“‚ æ‰“å¼€é…ç½® (Open)</button>
            <button class="btn-success" onclick="saveFile()">ğŸ’¾ ä¿å­˜é…ç½® (Save)</button>
            <button class="btn-danger" onclick="resetConfig()">ğŸ”„ é‡ç½®/æ–°å»º (New)</button>
        </div>
        <div id="file-status" style="width: 100%; font-size: 0.9em; color: #666; margin-top: 5px;">å½“å‰æœªé€‰æ‹©æ–‡ä»¶ (å°†åœ¨å†…å­˜ä¸­åˆ›å»ºæ–°é…ç½®)</div>
    </div>

    <div class="container">
        <!-- Key Column -->
        <div class="column">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>é”®ç›˜å® (Key Macros)</h2>
                <button class="btn-success btn-sm" onclick="addRule('key')">+ æ·»åŠ è§„åˆ™</button>
            </div>
            <div id="key-list"></div>
        </div>

        <!-- Mouse Column -->
        <div class="column">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>é¼ æ ‡å® (Mouse Macros)</h2>
                <button class="btn-success btn-sm" onclick="addRule('mouse')">+ æ·»åŠ è§„åˆ™</button>
            </div>
            <div id="mouse-list"></div>
        </div>
    </div>

    <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
    <button id="scroll-top-btn" title="å›åˆ°é¡¶éƒ¨" onclick="scrollToTop()">â†‘</button>

    <script>
        // --- 1. æ•°æ®æ¨¡å‹ä¸åˆå§‹åŒ– ---

        const defaultConfig = {
            key: [],
            mouse: []
        };

        let appConfig = JSON.parse(JSON.stringify(defaultConfig));
        let fileHandle = null;

        // å¸¸ç”¨é”®ç æ˜ å°„
        const vkMap = {
            1: "é¼ æ ‡å·¦é”®", 2: "é¼ æ ‡å³é”®", 4: "é¼ æ ‡ä¸­é”®", 
            8: "Backspace", 9: "Tab", 13: "Enter", 16: "Shift", 17: "Ctrl", 18: "Alt", 
            20: "CapsLock", 27: "Esc", 32: "Space",
            37: "Left", 38: "Up", 39: "Right", 40: "Down",
            46: "Delete",
            48: "0", 49: "1", 50: "2", 51: "3", 52: "4", 53: "5", 54: "6", 55: "7", 56: "8", 57: "9",
            65: "A", 66: "B", 67: "C", 68: "D", 69: "E", 70: "F", 71: "G", 72: "H", 73: "I", 74: "J",
            75: "K", 76: "L", 77: "M", 78: "N", 79: "O", 80: "P", 81: "Q", 82: "R", 83: "S", 84: "T",
            85: "U", 86: "V", 87: "W", 88: "X", 89: "Y", 90: "Z",
            112: "F1", 113: "F2", 114: "F3", 115: "F4", 116: "F5", 117: "F6", 
            118: "F7", 119: "F8", 120: "F9", 121: "F10", 122: "F11", 123: "F12"
        };

        // --- 2. æ¸²æŸ“é€»è¾‘ (UI Generation) ---

        function render() {
            renderCategory('key');
            renderCategory('mouse');
        }

        function renderCategory(category) {
            const container = document.getElementById(`${category}-list`);
            container.innerHTML = '';

            appConfig[category].forEach((rule, ruleIndex) => {
                const card = document.createElement('div');
                card.className = 'rule-card';

                // è§„åˆ™å¤´
                card.innerHTML = `
                    <div class="rule-header">
                        <span>è§„åˆ™ #${ruleIndex + 1}</span>
                        <button class="btn-danger btn-sm" onclick="deleteRule('${category}', ${ruleIndex})">åˆ é™¤è§„åˆ™</button>
                    </div>
                `;

                // è§„åˆ™ä½“
                const body = document.createElement('div');
                body.className = 'rule-body';

                // --- Match éƒ¨åˆ† (è§¦å‘æ¡ä»¶) ---
                const matchBox = document.createElement('div');
                matchBox.className = 'sequence-box';
                matchBox.innerHTML = `<h4>å½“æ£€æµ‹åˆ° (Match):</h4>`;
                
                rule.match.forEach((item, itemIndex) => {
                    const row = createActionRow(category, ruleIndex, 'match', itemIndex, item, false);
                    matchBox.appendChild(row);
                });
                
                const addMatchBtn = document.createElement('button');
                addMatchBtn.className = 'btn-primary btn-sm';
                addMatchBtn.innerText = '+ æ·»åŠ æ­¥éª¤';
                addMatchBtn.style.marginTop = '10px';
                addMatchBtn.onclick = () => addSequenceItem(category, ruleIndex, 'match');
                matchBox.appendChild(addMatchBtn);

                // --- Send éƒ¨åˆ† (æ¨¡æ‹Ÿè¾“å‡º) ---
                const sendBox = document.createElement('div');
                sendBox.className = 'sequence-box';
                sendBox.innerHTML = `<h4>æ¨¡æ‹Ÿå‘é€ (Send):</h4>`;

                rule.send.forEach((item, itemIndex) => {
                    // Send éƒ¨åˆ†éœ€è¦ isKey å­—æ®µ
                    const row = createActionRow(category, ruleIndex, 'send', itemIndex, item, true);
                    sendBox.appendChild(row);
                });

                const addSendBtn = document.createElement('button');
                addSendBtn.className = 'btn-primary btn-sm';
                addSendBtn.innerText = '+ æ·»åŠ æ­¥éª¤';
                addSendBtn.style.marginTop = '10px';
                addSendBtn.onclick = () => addSequenceItem(category, ruleIndex, 'send');
                sendBox.appendChild(addSendBtn);

                body.appendChild(matchBox);
                body.appendChild(sendBox);
                card.appendChild(body);
                container.appendChild(card);
            });
        }

        // åˆ›å»ºå•è¡Œæ“ä½œ UI (Match æˆ– Send çš„ä¸€è¡Œ)
        function createActionRow(category, ruleIndex, type, itemIndex, data, hasIsKey) {
            const div = document.createElement('div');
            div.className = 'action-item';

            // 1. isKey é€‰æ‹© (ä»… Send æœ‰)
            if (hasIsKey) {
                const typeSelect = document.createElement('select');
                typeSelect.style.width = "90px";
                typeSelect.innerHTML = `
                    <option value="true" ${data.isKey ? 'selected' : ''}>é”®ç›˜äº‹ä»¶</option>
                    <option value="false" ${!data.isKey ? 'selected' : ''}>é¼ æ ‡äº‹ä»¶</option>
                `;
                typeSelect.onchange = (e) => updateItem(category, ruleIndex, type, itemIndex, 'isKey', e.target.value === 'true');
                div.appendChild(typeSelect);
            }

            // 2. æŒ‰é”®ç  (Code)
            // ä¸‹æ‹‰è¾…åŠ©é€‰æ¡†
            const codeSelect = document.createElement('select');
            codeSelect.className = 'code-select';
            codeSelect.innerHTML = `<option value="-1">-- é€‰æ‹©æŒ‰é”® --</option>`;
            for (const [code, name] of Object.entries(vkMap)) {
                codeSelect.innerHTML += `<option value="${code}">${name} (${code})</option>`;
            }
            codeSelect.innerHTML += `<option value="custom">è‡ªå®šä¹‰...</option>`;
            
            if (vkMap[data.code]) {
                codeSelect.value = data.code;
            } else {
                codeSelect.value = 'custom';
            }

            // æ•°å­—è¾“å…¥æ¡† (å®é™…å€¼)
            const codeInput = document.createElement('input');
            codeInput.type = 'number';
            codeInput.value = data.code;
            codeInput.placeholder = 'Code';
            codeInput.title = 'Windows Virtual-Key Code (Decimal)';
            
            // è”åŠ¨é€»è¾‘
            codeSelect.onchange = (e) => {
                if (e.target.value !== 'custom' && e.target.value !== '-1') {
                    const val = parseInt(e.target.value);
                    codeInput.value = val;
                    updateItem(category, ruleIndex, type, itemIndex, 'code', val);
                }
            };
            codeInput.onchange = (e) => {
                const val = parseInt(e.target.value);
                updateItem(category, ruleIndex, type, itemIndex, 'code', val);
                if (vkMap[val]) codeSelect.value = val;
                else codeSelect.value = 'custom';
            };

            div.appendChild(codeSelect);
            div.appendChild(codeInput);

            // 3. åŠ¨ä½œç±»å‹ (æŒ‰ä¸‹/æŠ¬èµ·) - isUp
            const actionSelect = document.createElement('select');
            actionSelect.style.width = "85px";
            actionSelect.innerHTML = `
                <option value="false" ${!data.isUp ? 'selected' : ''}>æŒ‰ä¸‹</option>
                <option value="true" ${data.isUp ? 'selected' : ''}>æŠ¬èµ·</option>
            `;
            actionSelect.onchange = (e) => updateItem(category, ruleIndex, type, itemIndex, 'isUp', e.target.value === 'true');
            actionSelect.style.color = data.isUp ? '#dc3545' : '#28a745';
            actionSelect.style.fontWeight = 'bold';
            
            div.appendChild(actionSelect);

            // 4. åˆ é™¤æŒ‰é’®
            const delBtn = document.createElement('button');
            delBtn.className = 'btn-danger btn-sm btn-delete';
            delBtn.innerHTML = '&times;';
            delBtn.title = 'åˆ é™¤æ­¤æ­¥éª¤';
            delBtn.onclick = () => deleteSequenceItem(category, ruleIndex, type, itemIndex);
            div.appendChild(delBtn);

            return div;
        }


        // --- 3. æ•°æ®æ“ä½œé€»è¾‘ ---

        function addRule(category) {
            const newRule = {
                match: [ { isUp: false, code: 65 } ],
                send: [ 
                    { isKey: true, isUp: false, code: 66 }, 
                    { isKey: true, isUp: true, code: 66 } 
                ]
            };
            appConfig[category].push(newRule);
            render();
        }

        function deleteRule(category, index) {
            if(confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è§„åˆ™å—ï¼Ÿ')) {
                appConfig[category].splice(index, 1);
                render();
            }
        }

        function addSequenceItem(category, ruleIndex, type) {
            const newItem = { isUp: false, code: 0 };
            if (type === 'send') {
                newItem.isKey = true;
            }
            appConfig[category][ruleIndex][type].push(newItem);
            render();
        }

        function deleteSequenceItem(category, ruleIndex, type, itemIndex) {
            const list = appConfig[category][ruleIndex][type];
            if (list.length <= 1) {
                alert('æ¯ä¸ªåºåˆ—è‡³å°‘éœ€è¦ä¸€é¡¹ï¼');
                return;
            }
            list.splice(itemIndex, 1);
            render();
        }

        function updateItem(category, ruleIndex, type, itemIndex, field, value) {
            appConfig[category][ruleIndex][type][itemIndex][field] = value;
        }

        function resetConfig() {
            if(confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰é…ç½®å—ï¼Ÿæœªä¿å­˜çš„å†…å®¹å°†ä¸¢å¤±ã€‚')) {
                appConfig = JSON.parse(JSON.stringify(defaultConfig));
                fileHandle = null;
                document.getElementById('file-status').innerText = 'å·²é‡ç½® (æ–°é…ç½®)';
                render();
            }
        }

        // --- 4. æ–‡ä»¶ API å®ç° ---

        async function openFile() {
            try {
                const [handle] = await window.showOpenFilePicker({
                    types: [{
                        description: 'JSON Configuration',
                        accept: { 'application/json': ['.json'] }
                    }],
                    multiple: false
                });

                const file = await handle.getFile();
                const text = await file.text();

                try {
                    const json = JSON.parse(text);
                    
                    // --- ä¿®æ”¹ 1: å®½æ¾æ ¡éªŒ ---
                    // åªè¦ key æˆ– mouse å­˜åœ¨ä¸€ä¸ªå³å¯ï¼Œä¸éœ€è¦ä¸¤ä¸ªéƒ½å­˜åœ¨
                    if (!json.key && !json.mouse) {
                        throw new Error("JSON æ ¼å¼ä¸æ­£ç¡®: è‡³å°‘éœ€è¦åŒ…å« 'key' æˆ– 'mouse' å…¶ä¸­ä¸€ä¸ªå­—æ®µã€‚");
                    }
                    
                    // åˆå§‹åŒ–ä¸å­˜åœ¨çš„å­—æ®µä¸ºç©ºæ•°ç»„ï¼Œä¿è¯åº”ç”¨ä¸å´©æºƒ
                    appConfig = {
                        key: Array.isArray(json.key) ? json.key : [],
                        mouse: Array.isArray(json.mouse) ? json.mouse : []
                    };
                    
                    fileHandle = handle;
                    document.getElementById('file-status').innerText = `å½“å‰æ–‡ä»¶: ${file.name}`;
                    render();
                } catch (e) {
                    alert('è§£æ JSON å¤±è´¥: ' + e.message);
                }

            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error(err);
                    alert('æ‰“å¼€æ–‡ä»¶å‡ºé”™: ' + err.message);
                }
            }
        }

        async function saveFile() {
            const options = {
                types: [{
                    description: 'JSON Configuration',
                    accept: { 'application/json': ['.json'] }
                }],
            };

            if (fileHandle) {
                options.suggestedName = fileHandle.name;
            } else {
                options.suggestedName = "config.json";
            }

            try {
                const handle = await window.showSaveFilePicker(options);
                const writable = await handle.createWritable();
                const content = JSON.stringify(appConfig, null, 4);
                await writable.write(content);
                await writable.close();

                fileHandle = handle;
                document.getElementById('file-status').innerText = `å·²ä¿å­˜è‡³: ${handle.name}`;
                alert('ä¿å­˜æˆåŠŸï¼');

            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error(err);
                    alert('ä¿å­˜æ–‡ä»¶å‡ºé”™: ' + err.message);
                }
            }
        }

        // --- 5. å›åˆ°é¡¶éƒ¨é€»è¾‘ (ä¿®æ”¹ 3) ---
        const scrollBtn = document.getElementById("scroll-top-btn");

        window.onscroll = function() {
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                scrollBtn.style.display = "flex";
            } else {
                scrollBtn.style.display = "none";
            }
        };

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: "smooth"
            });
        }

        // --- åˆå§‹åŒ–è¿è¡Œ ---
        render();

    </script>
</body>
</html>